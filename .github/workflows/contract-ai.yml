name: Contract AI Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'examples/contract-ai/**'
      - 'src/core/contract-ai/**'
      - 'bin/reclapp'
  pull_request:
    branches: [main]
    paths:
      - 'examples/contract-ai/**'
      - 'src/core/contract-ai/**'

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # VALIDATE CONTRACTS
  # ============================================================================
  validate-contracts:
    name: Validate Contracts
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate contract files
        run: |
          echo "ğŸ” Validating contract files..."
          for contract in examples/contract-ai/*-contract.ts; do
            echo "  Checking: $contract"
            node -e "require('./$contract')" || exit 1
          done
          echo "âœ… All contracts valid"

  # ============================================================================
  # UNIT & INTEGRATION TESTS
  # ============================================================================
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: validate-contracts
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          node node_modules/.bin/jest tests/unit/contract-ai.test.ts --testTimeout=30000
      
      - name: Run integration tests
        run: |
          echo "ğŸ§ª Running integration tests..."
          node node_modules/.bin/jest tests/integration/contract-ai-flow.test.ts --testTimeout=60000

  # ============================================================================
  # CODE GENERATION (Simulation Mode)
  # ============================================================================
  generate-code:
    name: Generate Code (Simulation)
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        contract:
          - crm-contract.ts
          - blog-contract.ts
          - ecommerce-contract.ts
          - task-manager-contract.ts
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate code from ${{ matrix.contract }}
        run: |
          echo "ğŸ¤– Generating code from ${{ matrix.contract }}..."
          ./bin/reclapp generate-ai examples/contract-ai/${{ matrix.contract }} -o ./generated-${{ matrix.contract }}
      
      - name: Verify generated files
        run: |
          echo "ğŸ“ Checking generated files..."
          ls -la ./generated-${{ matrix.contract }}/
          
          # Check for required directories
          test -d ./generated-${{ matrix.contract }}/api || (echo "âŒ Missing api/" && exit 1)
          
          # Check for required files
          test -f ./generated-${{ matrix.contract }}/api/src/server.ts || (echo "âŒ Missing server.ts" && exit 1)
          test -f ./generated-${{ matrix.contract }}/api/package.json || (echo "âŒ Missing package.json" && exit 1)
          
          echo "âœ… Generated files verified"
      
      - name: Check validation log
        run: |
          echo "ğŸ“ Checking .rcl.md log..."
          if [ -d ./generated-${{ matrix.contract }}/logs ]; then
            cat ./generated-${{ matrix.contract }}/logs/*.rcl.md | head -100
          fi
      
      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-${{ matrix.contract }}
          path: ./generated-${{ matrix.contract }}/
          retention-days: 7

  # ============================================================================
  # SDK GENERATION
  # ============================================================================
  generate-sdk:
    name: Generate SDK
    runs-on: ubuntu-latest
    needs: generate-code
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate SDK from CRM contract
        run: |
          echo "ğŸ“¦ Generating SDK..."
          node -e "
            const { createSDKGenerator } = require('./src/core/contract-ai');
            const { crmContract } = require('./examples/contract-ai/crm-contract.ts');
            const fs = require('fs');
            
            const generator = createSDKGenerator();
            const sdk = generator.generate(crmContract);
            
            fs.mkdirSync('./generated-sdk', { recursive: true });
            for (const [filename, content] of sdk.files) {
              fs.writeFileSync('./generated-sdk/' + filename, content);
              console.log('  Generated: ' + filename);
            }
            console.log('âœ… SDK generated');
          "
      
      - name: Verify SDK files
        run: |
          echo "ğŸ“ SDK files:"
          ls -la ./generated-sdk/
          
          # Check types compile
          echo "ğŸ” Checking TypeScript types..."
          cat ./generated-sdk/types.ts | head -50
      
      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-sdk
          path: ./generated-sdk/
          retention-days: 7

  # ============================================================================
  # DOCKER BUILD (Optional)
  # ============================================================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: generate-code
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate code
        run: |
          ./bin/reclapp generate-ai examples/contract-ai/crm-contract.ts -o ./generated
      
      - name: Build Docker image
        run: |
          if [ -f ./generated/docker/Dockerfile ]; then
            echo "ğŸ³ Building Docker image..."
            docker build -t contract-ai-test -f ./generated/docker/Dockerfile ./generated/api
            echo "âœ… Docker build successful"
          else
            echo "âš ï¸ No Dockerfile found, skipping Docker build"
          fi

  # ============================================================================
  # SUMMARY
  # ============================================================================
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [validate-contracts, test, generate-code, generate-sdk]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Contract AI Pipeline Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  Validate Contracts: ${{ needs.validate-contracts.result }}"
          echo "  Unit/Integration Tests: ${{ needs.test.result }}"
          echo "  Code Generation: ${{ needs.generate-code.result }}"
          echo "  SDK Generation: ${{ needs.generate-sdk.result }}"
          echo ""
          
          if [ "${{ needs.validate-contracts.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.generate-code.result }}" == "failure" ]; then
            echo "âŒ Pipeline failed"
            exit 1
          else
            echo "âœ… Pipeline passed"
          fi
