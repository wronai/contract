# ============================================================================
# Reclapp 2.1.0 - AI-Native Declarative Platform
# ============================================================================
# 
# Usage:
#   make help          - Show all available commands
#   make install       - Install dependencies
#   make dev           - Start development server
#   make test          - Run all tests
#   make up     - Start Docker services
#   make publish       - Publish to npm
#
# ============================================================================

.PHONY: help install dev build test lint clean docker-build up down docker-logs logs docker-restart publish release stop stop-docker stop-dev

# Colors for output
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
NC := \033[0m # No Color

# Project info
PROJECT_NAME := reclapp
VERSION := 2.1.0
DOCKER_IMAGE := reclapp/platform

# ============================================================================
# ENV (load .env if present)
# ============================================================================

ifneq (,$(wildcard ../.env.examples))
include ../.env.examples
export $(shell sed -n 's/^\([A-Za-z_][A-Za-z0-9_]*\)=.*/\1/p' ../.env.examples)
endif

ifneq (,$(wildcard .env.examples))
include .env.examples
export $(shell sed -n 's/^\([A-Za-z_][A-Za-z0-9_]*\)=.*/\1/p' .env.examples)
endif

ifneq (,$(wildcard .env))
include .env
export $(shell sed -n 's/^\([A-Za-z_][A-Za-z0-9_]*\)=.*/\1/p' .env)
endif

# Defaults (can be overridden by .env or environment)
PORT ?= 8080
FRONTEND_PORT ?= 3000
EVENTSTORE_HTTP_PORT ?= 2113

API_URL ?= http://localhost:$(PORT)
FRONTEND_URL ?= $(if $(CORS_ORIGIN),$(CORS_ORIGIN),http://localhost:$(FRONTEND_PORT))
EVENTSTORE_HTTP_URL ?= http://localhost:$(EVENTSTORE_HTTP_PORT)

# ============================================================================
# HELP
# ============================================================================

help: ## Show this help message
	@echo ""
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘          Reclapp $(VERSION) - AI-Native Platform                  â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Available commands:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# ============================================================================
# INSTALLATION
# ============================================================================

install: ## Install all dependencies
	@echo "$(BLUE)ðŸ“¦ Installing dependencies...$(NC)"
	npm install
	cd frontend && npm install
	@echo "$(GREEN)âœ“ Dependencies installed$(NC)"

install-ci: ## Install dependencies for CI (no optional deps)
	@echo "$(BLUE)ðŸ“¦ Installing CI dependencies...$(NC)"
	npm ci
	cd frontend && npm ci
	@echo "$(GREEN)âœ“ CI dependencies installed$(NC)"

# ============================================================================
# DEVELOPMENT
# ============================================================================

dev: ## Start development server with hot reload
	@echo "$(BLUE)ðŸš€ Starting development server...$(NC)"
	npm run dev

stop: ## Stop all services (Docker + local dev)
	@echo "$(BLUE)ðŸ›‘ Stopping all services...$(NC)"
	@$(MAKE) stop-docker
	@$(MAKE) stop-dev
	@echo "$(GREEN)âœ“ All services stopped$(NC)"

stop-docker: ## Stop Docker services
	@echo "$(BLUE)ðŸ³ Stopping Docker services...$(NC)"
	@docker compose down --remove-orphans >/dev/null 2>&1 || true

stop-dev: ## Stop local dev processes (API + frontend)
	@echo "$(BLUE)ðŸ§¹ Stopping local dev processes...$(NC)"
	@pkill -f "[a]pi/src/server.ts" >/dev/null 2>&1 || true; \
	pkill -f "[t]s-node-dev" >/dev/null 2>&1 || true; \
	pkill -f "[v]ite" >/dev/null 2>&1 || true

dev-api: ## Start only API server
	@echo "$(BLUE)ðŸš€ Starting API server...$(NC)"
	npm run dev

dev-frontend: ## Start only frontend dev server
	@echo "$(BLUE)ðŸš€ Starting frontend...$(NC)"
	cd frontend && npm run dev

dev-all: ## Start all services in parallel
	@echo "$(BLUE)ðŸš€ Starting all development services...$(NC)"
	@make -j2 dev-api dev-frontend

watch: ## Watch for changes and rebuild
	@echo "$(BLUE)ðŸ‘ï¸ Watching for changes...$(NC)"
	npm run build -- --watch

# ============================================================================
# BUILD
# ============================================================================

build: ## Build the project
	@echo "$(BLUE)ðŸ”¨ Building project...$(NC)"
	npm run build
	@echo "$(GREEN)âœ“ Build complete$(NC)"

build-parser: ## Build DSL parser from grammar
	@echo "$(BLUE)ðŸ”¨ Building DSL parser...$(NC)"
	npm run build:parser
	@echo "$(GREEN)âœ“ Parser built$(NC)"

build-frontend: ## Build frontend for production
	@echo "$(BLUE)ðŸ”¨ Building frontend...$(NC)"
	cd frontend && npm run build
	@echo "$(GREEN)âœ“ Frontend built$(NC)"

build-all: build build-frontend ## Build everything
	@echo "$(GREEN)âœ“ All builds complete$(NC)"

# ============================================================================
# TESTING
# ============================================================================

test: ## Run all tests
	@echo "$(BLUE)ðŸ§ª Running all tests...$(NC)"
	npm test
	@echo "$(GREEN)âœ“ All tests passed$(NC)"

test-unit: ## Run unit tests only
	@echo "$(BLUE)ðŸ§ª Running unit tests...$(NC)"
	npm run test:unit

test-integration: ## Run integration tests only
	@echo "$(BLUE)ðŸ§ª Running integration tests...$(NC)"
	npm run test:integration

test-e2e: ## Run E2E tests only
	@echo "$(BLUE)ðŸ§ª Running E2E tests...$(NC)"
	npm run test:e2e

test-coverage: ## Run tests with coverage report
	@echo "$(BLUE)ðŸ§ª Running tests with coverage...$(NC)"
	npm run test:coverage
	@echo "$(GREEN)âœ“ Coverage report generated in coverage/$(NC)"

test-watch: ## Run tests in watch mode
	@echo "$(BLUE)ðŸ§ª Running tests in watch mode...$(NC)"
	npm run test:watch

test-ci: ## Run tests for CI pipeline
	@echo "$(BLUE)ðŸ§ª Running CI tests...$(NC)"
	npm run test:coverage -- --ci --reporters=default --reporters=jest-junit
	@echo "$(GREEN)âœ“ CI tests complete$(NC)"

# ============================================================================
# CODE QUALITY
# ============================================================================

lint: ## Run ESLint
	@echo "$(BLUE)ðŸ” Running linter...$(NC)"
	npm run lint

lint-fix: ## Run ESLint and fix issues
	@echo "$(BLUE)ðŸ”§ Fixing lint issues...$(NC)"
	npm run lint:fix

format: ## Format code with Prettier
	@echo "$(BLUE)âœ¨ Formatting code...$(NC)"
	npm run format

typecheck: ## Run TypeScript type checking
	@echo "$(BLUE)ðŸ” Type checking...$(NC)"
	npm run typecheck

check-all: lint typecheck test ## Run all checks (lint, typecheck, test)
	@echo "$(GREEN)âœ“ All checks passed$(NC)"

# ============================================================================
# DOCKER
# ============================================================================

docker-build: ## Build Docker images
	@echo "$(BLUE)ðŸ³ Building Docker images...$(NC)"
	docker compose build
	@echo "$(GREEN)âœ“ Docker images built$(NC)"

up: ## Start Docker services
	@echo "$(BLUE)ðŸ³ Starting Docker services...$(NC)"
	docker compose up -d --build --remove-orphans
	@echo "$(GREEN)âœ“ Services started$(NC)"
	@echo ""
	@echo "$(YELLOW)Services available at:$(NC)"
	@echo "  API:        $(API_URL)"
	@echo "  Frontend:   $(FRONTEND_URL)"
	@echo "  EventStore: $(EVENTSTORE_HTTP_URL)"

down: ## Stop Docker services
	@echo "$(BLUE)ðŸ³ Stopping Docker services...$(NC)"
	docker compose down --remove-orphans
	@echo "$(GREEN)âœ“ Services stopped$(NC)"

docker-logs: ## Show Docker logs
	docker compose logs -f

logs: docker-logs ## Alias for docker-logs

docker-restart: down up ## Restart Docker services

docker-full: ## Start all services including hardware and monitoring
	@echo "$(BLUE)ðŸ³ Starting full stack...$(NC)"
	docker compose --profile hardware --profile monitoring up -d
	@echo "$(GREEN)âœ“ Full stack started$(NC)"

docker-clean: ## Remove Docker containers and volumes
	@echo "$(RED)ðŸ—‘ï¸ Cleaning Docker resources...$(NC)"
	docker compose down -v --remove-orphans
	@echo "$(GREEN)âœ“ Docker resources cleaned$(NC)"

docker-shell: ## Open shell in API container
	docker compose exec api sh

# ============================================================================
# PUBLISHING
# ============================================================================

publish-check: ## Check if ready to publish
	@echo "$(BLUE)ðŸ” Checking publish readiness...$(NC)"
	@npm pack --dry-run
	@echo "$(GREEN)âœ“ Package is ready to publish$(NC)"

publish-npm: ## Publish to npm registry
	@echo "$(BLUE)ðŸ“¤ Publishing to npm...$(NC)"
	npm publish --access public
	@echo "$(GREEN)âœ“ Published to npm$(NC)"

publish-github: ## Publish to GitHub Packages
	@echo "$(BLUE)ðŸ“¤ Publishing to GitHub Packages...$(NC)"
	npm publish --registry=https://npm.pkg.github.com
	@echo "$(GREEN)âœ“ Published to GitHub Packages$(NC)"

# ============================================================================
# RELEASE
# ============================================================================

version-patch: ## Bump patch version (x.x.X)
	npm version patch

version-minor: ## Bump minor version (x.X.x)
	npm version minor

version-major: ## Bump major version (X.x.x)
	npm version major

release: check-all build ## Create a release (run checks, build, tag)
	@echo "$(BLUE)ðŸ·ï¸ Creating release...$(NC)"
	@VERSION=$$(node -p "require('./package.json').version"); \
	git tag -a "v$$VERSION" -m "Release v$$VERSION"; \
	echo "$(GREEN)âœ“ Tagged v$$VERSION$(NC)"
	@echo "$(YELLOW)Run 'git push --tags' to push the release$(NC)"

changelog: ## Generate changelog
	@echo "$(BLUE)ðŸ“ Generating changelog...$(NC)"
	@git log --pretty=format:"- %s (%h)" --no-merges $$(git describe --tags --abbrev=0 2>/dev/null || echo "")..HEAD
	@echo ""

# ============================================================================
# DOCUMENTATION
# ============================================================================

docs: ## Generate documentation
	@echo "$(BLUE)ðŸ“š Generating documentation...$(NC)"
	@mkdir -p docs/api
	npx typedoc --out docs/api ./contracts ./core ./dsl
	@echo "$(GREEN)âœ“ Documentation generated in docs/$(NC)"

docs-serve: ## Serve documentation locally
	@echo "$(BLUE)ðŸ“š Serving documentation...$(NC)"
	npx serve docs

articles-list: ## List all articles
	@echo "$(BLUE)ðŸ“° Available articles:$(NC)"
	@ls -1 articles/*.md | while read f; do echo "  - $$f"; done

articles-wordcount: ## Count words in articles
	@echo "$(BLUE)ðŸ“Š Article word counts:$(NC)"
	@wc -w articles/*.md | sort -n

# ============================================================================
# MCP SERVER
# ============================================================================

mcp-start: ## Start MCP server
	@echo "$(BLUE)ðŸ”Œ Starting MCP server...$(NC)"
	npm run mcp:server

mcp-test: ## Test MCP server connection
	@echo "$(BLUE)ðŸ”Œ Testing MCP server...$(NC)"
	curl -X POST http://localhost:8080/mcp \
		-H "Content-Type: application/json" \
		-d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}'

# ============================================================================
# DATABASE / EVENT STORE
# ============================================================================

db-migrate: ## Run database migrations
	@echo "$(BLUE)ðŸ—„ï¸ Running migrations...$(NC)"
	npm run db:migrate

db-seed: ## Seed database with test data
	@echo "$(BLUE)ðŸŒ± Seeding database...$(NC)"
	npm run db:seed

db-reset: ## Reset database
	@echo "$(RED)ðŸ—‘ï¸ Resetting database...$(NC)"
	npm run db:reset

# ============================================================================
# UTILITIES
# ============================================================================

clean: ## Clean build artifacts
	@echo "$(RED)ðŸ—‘ï¸ Cleaning build artifacts...$(NC)"
	rm -rf dist/
	rm -rf coverage/
	rm -rf node_modules/.cache/
	rm -rf frontend/dist/
	@echo "$(GREEN)âœ“ Cleaned$(NC)"

clean-all: clean ## Clean everything including node_modules
	@echo "$(RED)ðŸ—‘ï¸ Cleaning all...$(NC)"
	rm -rf node_modules/
	rm -rf frontend/node_modules/
	@echo "$(GREEN)âœ“ All cleaned$(NC)"

tree: ## Show project structure
	@echo "$(BLUE)ðŸ“‚ Project structure:$(NC)"
	@tree -I 'node_modules|dist|coverage|.git' -L 3 --dirsfirst

loc: ## Count lines of code
	@echo "$(BLUE)ðŸ“Š Lines of code:$(NC)"
	@find . -name "*.ts" -not -path "./node_modules/*" | xargs wc -l | tail -1

stats: ## Show project statistics
	@echo "$(BLUE)ðŸ“Š Project Statistics$(NC)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "TypeScript files: $$(find . -name '*.ts' -not -path './node_modules/*' | wc -l)"
	@echo "Test files:       $$(find . -name '*.test.ts' -not -path './node_modules/*' | wc -l)"
	@echo "Markdown files:   $$(find . -name '*.md' -not -path './node_modules/*' | wc -l)"
	@echo "Total LOC:        $$(find . -name '*.ts' -not -path './node_modules/*' | xargs cat | wc -l)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

env-check: ## Check environment setup
	@echo "$(BLUE)ðŸ” Checking environment...$(NC)"
	@echo "Node:    $$(node --version)"
	@echo "npm:     $$(npm --version)"
	@echo "Docker:  $$(docker --version 2>/dev/null || echo 'Not installed')"
	@echo "Git:     $$(git --version)"

# ============================================================================
# PACKAGE CREATION
# ============================================================================

pack: ## Create distributable package
	@echo "$(BLUE)ðŸ“¦ Creating package...$(NC)"
	@mkdir -p dist
	tar -czvf dist/$(PROJECT_NAME)-$(VERSION).tar.gz \
		--exclude='node_modules' \
		--exclude='dist' \
		--exclude='.git' \
		--exclude='coverage' \
		.
	@echo "$(GREEN)âœ“ Package created: dist/$(PROJECT_NAME)-$(VERSION).tar.gz$(NC)"

pack-zip: ## Create ZIP package
	@echo "$(BLUE)ðŸ“¦ Creating ZIP package...$(NC)"
	@mkdir -p dist
	zip -r dist/$(PROJECT_NAME)-$(VERSION).zip . \
		-x "node_modules/*" \
		-x "dist/*" \
		-x ".git/*" \
		-x "coverage/*"
	@echo "$(GREEN)âœ“ Package created: dist/$(PROJECT_NAME)-$(VERSION).zip$(NC)"

# ============================================================================
# CI/CD
# ============================================================================

ci: install-ci lint typecheck test-ci build ## Full CI pipeline
	@echo "$(GREEN)âœ“ CI pipeline complete$(NC)"

cd-prepare: ## Prepare for deployment
	@echo "$(BLUE)ðŸš€ Preparing deployment...$(NC)"
	@make build-all
	@make docker-build
	@echo "$(GREEN)âœ“ Deployment prepared$(NC)"

# ============================================================================
# DEFAULT
# ============================================================================

.DEFAULT_GOAL := help
